{{define "html"}}
<html>

<head>
  <title id="title">{{.Appname}}</title>
  <link rel="manifest" href="/manifest.json"> <!-- For Progressive Web App -->
  {{template "lib"}}
  <script type="text/javascript" src="/static/lib/sand.min.js"></script>
  {{range .Libs}}
  <script type="text/javascript" src="{{.}}"></script>
  {{end}} {{template "css"}}
  <link rel="stylesheet" href="/static/css/sand.base.css">
  <!-- THEME
  -->
  {{range .Styles}}
  <link rel="stylesheet" href="{{.}}"> {{end}}
<style>
.hide {
    display:none;
}
</style>
</head>

<body style="height:100%">
  {{template "menu"}} 
    <div id="notify" class="hide">A new version of this app is available. Click <a id="reload">here</a> to update.</div>
  {{template "wrapper"}} 
  {{ template "modal"}} 
  {{ template "modalLoad"}} 
  {{ template "modalSave"}} 
  {{ template "modalPrompt"}}
</body>
<script>
  var eventHub;
  var isAstilectron = false;
  var url = window.location.href
  var arr = url.split("/");
  var domain = arr[0] + "//" + arr[2];
  var server = ""; //TODO
  var app = {};
  var sandUser
  var sandHeaders = new Headers({})
  //var sandInits = {credentials:"same-origin"}
  var sandInits = {credentials:"include"}
  var mode
  var win
  var winid
  var fixedLayout
  var initedLayout
  var lite = 0
 
  sand.waitForWebfonts(["Roboto Mono"],function(){
  (function($, d3, S) {
    /* init theme */
    mode = "web" //other modes obsoleted
    win = S.toolsGetUrlPara("win") || "main"
    winid = S.toolsGetUrlPara("winid") || -1
    fixedLayout = S.toolsGetUrlPara("fixedLayout") || 0 //0 is false
    initedLayout = S.toolsGetUrlPara("initedLayout") || undefined // hub,gsheet et al.
    lite = S.toolsGetUrlPara("lite") || 0 //remove google user system is lite is 1
    if (win == "ext") {
      d3.select("body").classed("extWin",true)
      $("#myNavRight").hide() //hide session ctrl
      $("#openExt").hide()
      $("#home").hide()
      $("#title").text("Extend Window " + winid) 
    } else {
      d3.select("body").classed("mainWin",true)
    }
    var theme = S.initTheme();

    var renders = eval({{.Renders}}); //TODO ADD Interface
    var renderList = Object.keys(renders).sort()
    var dispatch = d3.dispatch("sendMessage", "receiveMessage", "initWindows", "initPanels", "input", "resize", "sendState", "saveState", "add", "exportState", "exportStates", "exportStatesToFile", "setState", "importState", "importStates",
      "openExt","closeExt","renderExtWinNav", "loadPanel",
      "saveSession", "loadSession", "shareSession", "saveToSheet", "loadFromSheet", "saveToGSheet", "refreshWorkSpace")
    var message = {}
    var app = {}
    d3.json("/userinfo",{credentials:"same-origin"}).then(function(d){
      sandUser=d
      sandHeaders = new Headers({"Authorization":"Basic "+btoa(sandUser.email)}) //Authorization for future data server 
      sandInits["headers"] = sandHeaders
    })
    d3.select("#logo")
      .attr("title","Back to Login Page")
      .on("click",function(){
        window.open("/static/")
      })
    d3.select("#appinfo").text("{{.Appname}}")

    var M = S.initMenu().renders(renders).renderList(renderList).dispatch(dispatch);
    M();
    window.PanelManager = S.NewPanelManager()
      .dispatch(dispatch)
      .renders(renders)
      .renderList(renderList)
      .app(app)

    PanelManager();

    if (fixedLayout) {
      document.body.className += ' ' + 'fixedLayout';
    }
    if (lite) {
      document.body.className += ' ' + 'liteVersion';
    }
    /* TODO add functions to Init Some Renders */
    var emptyCfg = {
      "settings": {
        "showPopoutIcon": false
      },
      "dimensions": {
        "borderWidth": 2
      },
      "content": [{
        "type": "row",
        "content": []
      }]
    }
    var cfg = S.toolsGetUrlPara("config")
    if (!cfg && initedLayout) { //config override the initedLayout
      initedLayout.split(",").forEach(function(d) {
        if (renders[d]) {
          emptyCfg.content[0].content.push({
            "type": "component",
            "componentName": "canvas",
            "title": renders[d].label || d,
            "componentState": {
              "render": d,
            }
          })
        }
      })
    }
    if (win == "main") { //any other condition
      var W = S.NewWindowManager().dispatch(dispatch).theme(theme).domain(domain).P(PanelManager).win(win).config(cfg).chromeExtID({{.ExtID}}) //app(app) //init windows manager
      W();
    } else if (win == "ext") {
        var W1 = S.NewWindowManager().dispatch(dispatch).theme(theme).domain(domain).P(PanelManager).win(win).config(cfg).chromeExtID({{.ExtID}}) //app(app) //init windows manager
      W1();
    }
    /* TO USE PUBLIC GSHEET */
    window._renderGsheet = function(d) {
      var config = JSON.parse(d.table.rows[0].c[2].v)
      if (config[-1] || config["states"]) { //windows format
        dispatch.call("initWindows", this, config)
      } else { // one window format
        dispatch.call("initPanels", this, config)
      }
    }

    if (cfg && cfg.match(/gsheet:\S+:\S+/)) {
      var a = cfg.split(":")
      S.gsheetQuery("select * where A='" + a[2] + "'", a[1], "_renderGsheet")
    } else if (cfg && cfg.match(/localstorage:\S+/) ){
        var a = cfg.split(":")
        var sessionDb = localforage.createInstance({
            "name": "nbSession"
        })
        sessionDb.getItem(a[1]).then(function(d){
          dispatch.call("initWindows", this, JSON.parse(d.data))
        })
    } else if (cfg && cfg != "continue") {
      $(".menu .note").hide()
      d3.json(server + cfg, sandInits).then(function(config) {
        if (config[-1] || config["states"]) { //windows format
          dispatch.call("initWindows", this, config)
        } else { // one window format
          dispatch.call("initPanels", this, config)
        }
      }).catch(function(){

      })
   }  else if (!cfg) {
      if (win == "main") {
        $(".menu .note").show()
      }
      dispatch.call("initPanels", this, emptyCfg)
   }

    window.onresize = function() {
        if ($("#menuContainer").css("display")=="block") {
            $("#layoutContainer").css('width',"100%").css("width","-=200px").css("left", "200px")
        }
        dispatch.call("resize", this, {})
    }
    history.pushState({},"main","/v1/main.html")
  })(jQuery, d3, sand)
});
</script>
{{range .Tail}}
<script type="text/javascript" src="{{.}}"></script>
{{end}}
<html>
{{end}}
