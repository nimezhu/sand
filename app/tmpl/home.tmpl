{{define "title"}} CNB User Home {{end}} {{define "id"}} "cnb000"{{end}} {{define "homemenu"}}
<div class="menu fn-clear">
  <ul id="myNavLeft">
    <li id="play" title="start application"><span class="glyphicon glyphicon-play"></span>Start Application</li>
    <li style="padding-right:0px" title="Login with google" id="menuUser"><span id="login" class="glyphicon glyphicon-log-in"></li>
    <li style="padding-right:0px"><image id="picture" style="height:18px;width:18px;margin:7px 4px"></image>
    <div class="frame">
      <ul>
      <li id="logout" title="Logout"><span class="glyphicon glyphicon-log-out" title="logout"></span> Log Out</li>
  </ul>
</div>
</li>
</ul>
<ul id="myNavRight" style="float:right">
  <li id="logo">
    <image src="/static/image/icon.png" style="height:18px;width:18px;margin:7px 4px"></image><span id="appinfo" style="color:#777"></span>
  </li>
</ul>
</div>
{{end}} {{define "html"}}
<html>

<head>
  <title>{{template "title"}}</title>
  {{template "lib"}}
  <script type="text/javascript" src="/web/lib/sand.min.js"></script>

  {{template "css"}}
  <link rel="stylesheet" href="/web/style/sand.base.css">

  <style>
    .panel {
      width: 300px;
      height: 530px;
      float: left;
      margin: 10px;
    }

    #layoutContainer {
      overflow-y: scroll;
    }

    .menu {
      background-color: #F0F0F0;
    }

    .selected {
      background-color: #CFCFCF;
    }
    h4 {
      font-size: 16px;
      color: #336289;
    }
    .active, li:active {
        color : lightyellow;
        background-color: #336289;
    }
    li:hover {
        color: #333333;
        background-color: lightyellow;
    }

  </style>
</head>

<body>
  {{template "homemenu"}}
  <div id="wrapper" style="height:calc(100%-20px)">
    <div id="menuContainer" style="display:none"></div>
    <div id="layoutContainer" style="left:0%;width:100%">
      <div class="panel">
        <div class="panel-head">
        </div>
        <div class="panel-body">
          <form>
            <div class="form-group">
              <label for="sheetIdInput">Google SheetID to Host Sessions</label>
              <input type="text" class="form-control" id="sheetIdInput" placeholder="">
            </div>
            <button id="edit" class="btn btn-success">Edit</button>
            <button id="load" class="btn btn-primary">Load</button>
            <button id="submit" type="submit" class="btn btn-primary">Submit</button>
          </form>
        </div>
      </div>
    </div>
</body>
<script>
  (function($, d3, S) {
    var niceFormat = d3.format(",")
    var regionNiceText = function(d){
        return d.chr + ":" + niceFormat(d.start) + "-" + niceFormat(d.end)
    } 
    var regionsNiceText = function(d){
        var r = []
        d.forEach(function(d){
            r.push(regionNiceText(d))
        })
        return r.join(";")
    }

    var stateId = "cnb000"
    var links = []
    var sandInits = {
      credentials: "same-origin"
    }
    var container = d3.select("#layoutContainer")
    var ctrldiv = container.append("div").classed("ctrl", true)
    var currentdiv = container.append("div").style("background-color", "#cee8d9")
    var panelsdiv = container.append("div")
    //ctrldiv.append("span").text("SheetID:").style("padding-right","10px")
    var sheetIdInput = d3.select("#sheetIdInput")
    var currentId = ""
    var fLoad = function() {
      d3.json("/getsheetid", sandInits).then(function(d) {
        sheetIdInput.node().value = d.sheetid
        currentId = d.sheetid
        renderSessions()
      })
    }
    fLoad()
    d3.select("#load")
      .on("click", function() {
        fLoad()
      })
    d3.select("#submit")
      .on("click", function() {
        var id = sheetIdInput.node().value
        if (id != null && id != "" && id.length == 44 && id != currentId) {
          $.ajaxSetup({
            xhrFields: {
              withCredentials: true
            },
          });
          $.post("/setsheetid?id=" + id).done(function() {
            renderSessions();
          })
        } else if (id == currentId) {
          renderSessions();
        }
      })
    d3.select("#edit")
      .on("click", function() {
        window.open("https://docs.google.com/spreadsheets/d/" + currentId + "/edit")
      })
/*
    var iconRender = S.layoutIcon().xscale(2.70).yscale(1.68)
  
        var trans = function(d) {
          if (d=="-1") {return "main"}
          return "ext"+d
      }

      var _render = function(el) {
        el.each(function(d) {
          var div = d3.select(this).append("div")
          var iconRender = S.layoutIcon().xscale(2.70).yscale(1.68)
          //TODO WITH OTHER EXTERNAL WINDOW
          var allw = JSON.parse(d[2])
          var keys = Object.keys(allw).sort(function(a,b){return parseInt(a) > parseInt(b)})
          keys.shift()
          var d = []
          keys.forEach(function(k){
            d.push(JSON.parse(allw[k]));
          })
           var ul = div.append("ul").classed("nav",true).classed("nav-tabs",true)
           var tabdiv = div.append("div")
           tabdiv.selectAll(".tabdiv").data(d)
             .enter()
             .append("div")
             .classed("tabdiv",true)
             .style("display","none")
             .append("svg")
             .attr("width",270)
             .attr("height",150)
             .call(iconRender)

           var lis = ul.selectAll("li").data(keys)
           .enter()
           .append("li")
           .on("click",function(d,i){
                tabdiv.selectAll(".tabdiv").style("display","none")
                ul.selectAll("li").classed("active",false)
                tabdiv.select(".tabdiv:nth-child("+(i+1)+")").style("display",null) 
                ul.select("li:nth-child("+(i+1)+")").classed("active",true)
           })
           .text(function(k){return trans(k)})
            ul.select("li:nth-child(1)").classed("active",true)
            tabdiv.select(".tabdiv:nth-child(1)").style("display",null) 
          } 
        )
      }
      

    var pchart = function(selection) {
      selection.each(function(d, i) {
        var el = d3.select(this)
        el.selectAll("div").remove()
        el.append("div")
          .classed("panel-heading", true)
          .append("h2")
          .classed("panel-title", true)
          .text(function(d) {
            return d[0]
          })
          .on("click", function(d) {
            window.location = d[3] || "/v1/main.html?config=/sheet?idx=" + (i + 1);
          })
          .on("mouseover", function() {
            d3.select(this).style("background-color", "#8899AA")
          })
          .on("mouseout", function() {
            d3.select(this).style("background-color", "#F5F5F5")
          })
        var pbody = el.append("div")
          .classed("panel-body", true)
        pbody.append("div").append("h4").text("Description")
        pbody.append("div").style("overflow-wrap", "break-word")
          .style("background-color","#fffbea")
          .style("overflow-y","auto")
          .style("height","100px")
          .style("padding", "5px").text(function(d) {
            return d[1]
          })
 
        var regions = pbody.append("div")
        regions.append("h4").text("Regions")
        var regionsDiv = regions.append("div").style("height","50px").style("overflow-y","auto")
        regionsDiv.text(function(d){
          var k = JSON.parse(JSON.parse(d[2])[-2])
          if (k.regions){
            return regionsNiceText(k.regions)
          } else {
            return "null"
          }
        })


        pbody.append("div").append("h4").text("Layout")
        var svgdiv = pbody.append("div").style("padding-bottom", "10px")
        svgdiv.call(_render)
            var btnGrp = pbody.append("div").append("span").style("float", "right").style("padding-right", "25px")
        btnGrp.append("button")
          .classed("btn", true)
          .classed("btn-success", true)
          .classed("btn-sm", true)
          .on("click", function() {
            window.open(d[3] || "/v1/main.html?config=/sheet?idx=" + (i + 1))
          })
          .text("open")
      })
    }

*/
    var pchart=S.layoutPanel();//TODO

    var renderSessions = function() {
      d3.json("/sheetlist", sandInits).then(function(d) { //TODO sheets
        var panels = panelsdiv
          .selectAll(".panel")
          .data(d)
        panels.exit().remove()
        panels.enter()
          .append("div")
          .merge(panels)
          .classed("panel", true)
          .classed("panel-default", true)
          .call(pchart)
      })
    }


    $.get("/profile", function(d) {
      d = JSON.parse(d);
      if (d.email) {
        $("#logout").show();
        $("#login").hide();
        $("#picture").show()
        var name = d.name
        if (name == "") {
          name = d.email
        }
        $("#picture").attr("src", d.picture).attr("title", name)
      } else {
        $("#logout").hide();
        $("#login").show();
        $("#picture").hide();
      }
    })

    d3.select("#logo")
      .attr("title", "Click to open introduction")
      .on("click", function() {
        window.open("/static/")
      })
    d3.select("#appinfo").text("{{.Appname}} v{{.Version}}")

    $(".menu > ul > li").mouseover(function(event) {
      $(this).addClass("selected");
    })
    $(".menu > ul > li").mouseout(function() {
      $(this).removeClass("selected");
    })

    /* local session */
    var sessionId = "_cnb_"
    var d = localStorage.getItem(sessionId)
    if (d) {
      var d = ["Current", "Current Session", d, "/v1/main.html?config=continue"]
      //var svg = currentdiv.append("svg").attr("height","300px").attr("width","300px")
      //svg.datum(JSON.parse(p[-1])).call(iconRender)
      var _panels = currentdiv
        .selectAll(".panel")
        .data([d])
      _panels.exit().remove()
      _panels.enter()
        .append("div")
        .merge(_panels)
        .classed("panel", true)
        .classed("panel-default", true)
        .call(pchart)
    }

    $("#play").click(function() {
      window.location = "/v1/main.html"
    })
  }(jQuery, d3, sand))
</script>

</html>
{{end}}
